name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-latest
            script: package
          - os: ubuntu-latest
            script: package-linux
          - os: windows-latest
            script: package-win

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - run: bun install

      - run: bun run ${{ matrix.script }}

      - uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}
          path: release/
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.vars.outputs.version }}
      dmg_sha256: ${{ steps.hashes.outputs.dmg_sha256 }}
      exe_sha256: ${{ steps.hashes.outputs.exe_sha256 }}

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Extract version and compute hashes
        id: vars
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Compute artifact SHA256 hashes
        id: hashes
        run: |
          DMG=$(shasum -a 256 artifacts/BloomRPC-Extended-${{ steps.vars.outputs.version }}-arm64.dmg | awk '{print $1}')
          EXE=$(shasum -a 256 artifacts/BloomRPC-Extended-Setup-${{ steps.vars.outputs.version }}.exe | awk '{print $1}')
          echo "dmg_sha256=$DMG" >> "$GITHUB_OUTPUT"
          echo "exe_sha256=$EXE" >> "$GITHUB_OUTPUT"

      - uses: softprops/action-gh-release@v2
        with:
          draft: false
          generate_release_notes: true
          files: |
            artifacts/*.dmg
            artifacts/*.AppImage
            artifacts/*.deb
            artifacts/*.exe

  publish-homebrew:
    needs: release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Checkout Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: ahmethakanbesel/homebrew-bloomrpc-extended
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: homebrew-tap

      - name: Update cask formula
        run: |
          sed \
            -e 's/__VERSION__/${{ needs.release.outputs.version }}/g' \
            -e 's/__SHA256__/${{ needs.release.outputs.dmg_sha256 }}/g' \
            .github/templates/bloomrpc-extended.rb.template \
            > homebrew-tap/Casks/bloomrpc-extended.rb

      - name: Commit and push to tap
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/bloomrpc-extended.rb
          git diff --staged --quiet && echo "No changes to commit" || (git commit -m "Update bloomrpc-extended to ${{ needs.release.outputs.version }}" && git push)

  publish-scoop:
    needs: release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Checkout Scoop bucket
        uses: actions/checkout@v4
        with:
          repository: ahmethakanbesel/scoop-bloomrpc-extended
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: scoop-bucket

      - name: Update Scoop manifest
        run: |
          sed \
            -e 's/__VERSION__/${{ needs.release.outputs.version }}/g' \
            -e 's/__SHA256__/${{ needs.release.outputs.exe_sha256 }}/g' \
            .github/templates/bloomrpc-extended.json.template \
            > scoop-bucket/bucket/bloomrpc-extended.json

      - name: Commit and push to bucket
        run: |
          cd scoop-bucket
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add bucket/bloomrpc-extended.json
          git diff --staged --quiet && echo "No changes to commit" || (git commit -m "Update bloomrpc-extended to ${{ needs.release.outputs.version }}" && git push)
